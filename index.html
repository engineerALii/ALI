<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>سبورة الأفكار المطورة</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cairo:wght@300;400;600;700&family=Reem+Kufi:wght@400;500;600&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #f3f4f6;
            --dot-color: #cbd5e1;
            --text-color: #1f2937;
            --toolbar-bg: rgba(255, 255, 255, 0.95);
            --toolbar-text: #4b5563;
        }

        [data-theme="dark"] {
            --bg-color: #1e1e1e;
            --dot-color: #333333;
            --text-color: #e5e7eb;
            --toolbar-bg: rgba(30, 30, 30, 0.95);
            --toolbar-text: #e5e7eb;
        }

        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s;
            touch-action: none;
        }

        /* --- شريط التبويبات --- */
        .boards-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: var(--toolbar-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            z-index: 20000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
        }

        .board-tab {
            padding: 5px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--toolbar-text);
            transition: all 0.2s;
            border: 2px solid transparent;
            opacity: 0.7;
        }
        .board-tab:hover { opacity: 1; background: rgba(0,0,0,0.05); }
        .board-tab.active {
            opacity: 1;
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        /* --- منطقة السبورة --- */
        #board {
            width: 100%;
            height: 100%;
            padding-top: 50px;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--dot-color) 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            cursor: grab;
            transition: background 0.3s ease;
        }
        #board:active { cursor: grabbing; }

        /* --- تصميم الملاحظات --- */
        .note {
            position: absolute;
            min-width: 180px;
            min-height: 180px;
            width: 260px;
            background-color: #fff;
            padding: 0;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            user-select: none;
            animation: popIn 0.2s ease-out;
            touch-action: none;
            transform: rotate(0deg); 
        }

        .note:hover {
            box-shadow: 5px 8px 20px rgba(0,0,0,0.2);
            z-index: 1000 !important;
        }
        .note.dragging {
            opacity: 0.95;
            box-shadow: 10px 15px 30px rgba(0,0,0,0.25);
            z-index: 10000 !important;
        }

        /* أنماط الورق */
        .note.style-lined .note-content {
            background-image: repeating-linear-gradient(transparent, transparent 29px, #94a3b8 30px);
            line-height: 30px;
            padding-top: 5px;
        }
        .note.style-grid .note-content {
            background-image: linear-gradient(#cfd8dc 1px, transparent 1px), linear-gradient(90deg, #cfd8dc 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .note.style-kraft {
            background-color: #d2b48c !important;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZDJiNDhjIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiM4YjQ1MTMiIG9wYWNpdHk9IjAuMSIvPgo8L3N2Zz4=');
        }

        /* رأس الملاحظة */
        .note-header {
            height: 40px;
            background: rgba(0,0,0,0.03);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px;
            touch-action: none;
        }

        .move-btn {
            color: #64748b;
            cursor: grab;
            width: 36px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background: rgba(255,255,255,0.7);
            border: 1px solid rgba(0,0,0,0.1);
            font-size: 16px;
            touch-action: none;
        }
        
        .move-btn:active {
            background: #3b82f6;
            color: white;
            cursor: grabbing;
        }
        
        .move-btn i { pointer-events: none; }

        .delete-btn {
            color: #ef4444;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
            z-index: 50; /* ضمان أن الزر فوق الطبقات الأخرى */
        }
        .delete-btn:hover { background: rgba(239, 68, 68, 0.1); }
        .delete-btn i { pointer-events: none; }

        .note-content {
            flex-grow: 1;
            padding: 15px;
            outline: none;
            cursor: text;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            font-size: 1.1rem;
            color: #1f2937;
            overflow: auto;
            user-select: text;
        }

        .note-image {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
        }

        .resize-handle {
            width: 35px;
            height: 35px;
            position: absolute;
            bottom: 0;
            left: 0;
            cursor: sw-resize;
            z-index: 20;
            touch-action: none;
        }
        .resize-handle::after {
            content: '';
            position: absolute;
            bottom: 6px; left: 6px;
            width: 12px; height: 12px;
            border-bottom: 3px solid rgba(0,0,0,0.2);
            border-left: 3px solid rgba(0,0,0,0.2);
        }

        /* شريط الأدوات */
        .toolbar {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--toolbar-bg);
            backdrop-filter: blur(10px);
            padding: 8px 20px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: flex;
            gap: 12px;
            z-index: 10000;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .tool-btn {
            width: 45px; height: 45px;
            border-radius: 50%; border: none;
            background: transparent; color: var(--toolbar-text);
            font-size: 1.1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: rgba(0,0,0,0.05); }

        /* الإعدادات */
        .settings-panel {
            position: absolute; bottom: 85px; left: 50%;
            transform: translateX(-50%) scale(0.95);
            background: var(--toolbar-bg);
            padding: 15px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none; width: 320px; z-index: 9999;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .settings-panel.active { display: block; transform: translateX(-50%) scale(1); }
        
        .section-title { font-size: 0.85rem; font-weight: bold; opacity: 0.7; margin-bottom: 8px; display: block; }
        .style-option {
            border: 1px solid #ddd; border-radius: 6px;
            padding: 6px 10px; font-size: 0.8rem;
            cursor: pointer; background: #fff; color: #333;
        }
        .style-option.active { background: #3b82f6; color: white; border-color: #3b82f6; }

        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div class="boards-nav">
        <div class="board-tab active" onclick="switchBoard(0)">الرئيسية</div>
        <div class="board-tab" onclick="switchBoard(1)">مسودة 1</div>
        <div class="board-tab" onclick="switchBoard(2)">مسودة 2</div>
        <div class="board-tab" onclick="switchBoard(3)">أفكار</div>
    </div>

    <div id="board"></div>

    <div class="toolbar">
        <button class="tool-btn bg-blue-100 text-blue-600 hover:bg-blue-200" onclick="addNote()" title="إضافة">
            <i class="fa-solid fa-plus"></i>
        </button>
        <button class="tool-btn" onclick="document.getElementById('imageInput').click()" title="صورة">
            <i class="fa-regular fa-image"></i>
        </button>
        <button class="tool-btn" onclick="toggleSettings()" title="تنسيق">
            <i class="fa-solid fa-paintbrush"></i>
        </button>
        <button class="tool-btn" onclick="toggleTheme()" title="الوضع">
            <i class="fa-solid fa-moon" id="themeIcon"></i>
        </button>
        <div class="w-px h-6 bg-gray-300 mx-1"></div>
        <button class="tool-btn text-red-500 hover:bg-red-50" onclick="clearCurrentBoard()" title="مسح السبورة الحالية">
            <i class="fa-regular fa-trash-can"></i>
        </button>
    </div>

    <!-- نافذة التأكيد (Modal) - البديل لـ confirm -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[20000] hidden backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-xs w-full mx-4 text-center transform transition-all scale-100">
            <div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-triangle-exclamation text-xl"></i>
            </div>
            <h3 class="text-lg font-bold mb-2 text-gray-800 dark:text-gray-100">تأكيد الإجراء</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6 text-sm" id="confirmMessage">هل أنت متأكد؟</p>
            <div class="flex justify-center gap-3">
                <button onclick="closeModal()" class="flex-1 px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium transition-colors">إلغاء</button>
                <button id="confirmBtn" class="flex-1 px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium transition-colors shadow-lg shadow-red-500/30">نعم، احذف</button>
            </div>
        </div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <span class="section-title">لون الورقة</span>
        <div class="flex flex-wrap gap-2 mb-4" id="colorPicker"></div>

        <span class="section-title">تصميم الورقة</span>
        <div class="flex gap-2 mb-4">
            <button class="style-option active" onclick="setNoteStyle('plain', this)">سادة</button>
            <button class="style-option" onclick="setNoteStyle('lined', this)">مسطر</button>
            <button class="style-option" onclick="setNoteStyle('grid', this)">مربعات</button>
            <button class="style-option" onclick="setNoteStyle('kraft', this)">كرافت</button>
        </div>

        <span class="section-title">الخط</span>
        <select id="fontSelect" onchange="setCurrentFont(this.value)" class="w-full p-2 border rounded text-sm bg-gray-50 text-gray-800">
            <option value="'Tajawal', sans-serif">تجوال (افتراضي)</option>
            <option value="'Amiri', serif">أميري (تقليدي)</option>
            <option value="'Reem Kufi', sans-serif">ريم كوفي</option>
            <option value="'Cairo', sans-serif">كايرو (عصري)</option>
        </select>
    </div>

    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">

    <script>
        const board = document.getElementById('board');
        let currentBoardIndex = 0;
        let zIndexCounter = 100;
        let pendingCallback = null; // لتخزين الدالة المراد تنفيذها بعد التأكيد
        
        let currentSettings = {
            color: '#ffffff',
            style: 'plain', 
            font: "'Tajawal', sans-serif"
        };

        const colors = ['#ffffff', '#feff9c', '#fff740', '#cbf078', '#7afcff', '#ff7eb9', '#e2e8f0', '#fca5a5'];

        window.onload = function() {
            initColorPicker();
            loadBoard(0);
            if(localStorage.getItem('boardTheme') === 'dark') toggleTheme(true);
        };

        // --- إدارة النافذة المنبثقة (Modal) ---
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').innerText = message;
            pendingCallback = callback;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            pendingCallback = null;
        }

        document.getElementById('confirmBtn').onclick = function() {
            if(pendingCallback) pendingCallback();
            closeModal();
        };

        // --- وظائف اللوحة والملاحظات ---
        function switchBoard(index) {
            saveCurrentBoard();
            currentBoardIndex = index;
            document.querySelectorAll('.board-tab').forEach((tab, i) => {
                if(i === index) tab.classList.add('active');
                else tab.classList.remove('active');
            });
            loadBoard(index);
        }

        function loadBoard(index) {
            board.innerHTML = '';
            const allData = JSON.parse(localStorage.getItem('myIdeaBoards') || '{}');
            const boardData = allData[index] || [];
            
            // تم إزالة شرط الملاحظة الترحيبية
            if (boardData.length > 0) {
                boardData.forEach(n => createNoteElement(n));
            }
        }

        function saveCurrentBoard() {
            const notesData = [];
            document.querySelectorAll('.note').forEach(note => {
                const contentDiv = note.querySelector('.note-content');
                notesData.push({
                    id: note.id,
                    html: contentDiv.innerHTML,
                    left: note.style.left,
                    top: note.style.top,
                    width: note.style.width,
                    height: note.style.height,
                    color: note.dataset.color,
                    style: note.dataset.style,
                    font: note.style.fontFamily
                });
            });
            const allData = JSON.parse(localStorage.getItem('myIdeaBoards') || '{}');
            allData[currentBoardIndex] = notesData;
            localStorage.setItem('myIdeaBoards', JSON.stringify(allData));
        }

        function addNote(text = '', x = null, y = null, img = null) {
            const noteData = {
                id: `note-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                html: img ? `<img src="${img}" class="note-image">` : text,
                left: (x !== null ? x : Math.max(20, window.innerWidth/2 - 130)) + 'px',
                top: (y !== null ? y : Math.max(60, window.innerHeight/2 - 130)) + 'px',
                width: '260px',
                height: '260px',
                color: currentSettings.color,
                style: currentSettings.style,
                font: currentSettings.font
            };
            createNoteElement(noteData);
            saveCurrentBoard();
        }

        function createNoteElement(data) {
            const note = document.createElement('div');
            note.className = `note style-${data.style}`;
            note.id = data.id;
            note.style.left = data.left;
            note.style.top = data.top;
            note.style.width = data.width;
            note.style.height = data.height;
            note.style.fontFamily = data.font;
            note.style.backgroundColor = data.color;
            note.style.zIndex = zIndexCounter++;
            
            note.dataset.color = data.color;
            note.dataset.style = data.style;

            if (data.style === 'kraft') note.style.color = '#3e2723';

            note.innerHTML = `
                <div class="note-header">
                    <div class="move-btn" title="اسحب من هنا">
                        <i class="fa-solid fa-up-down-left-right"></i>
                    </div>
                    <div class="delete-btn" onclick="deleteNote('${data.id}')" title="حذف">
                        <i class="fa-solid fa-xmark"></i>
                    </div>
                </div>
                <div class="note-content" contenteditable="true" spellcheck="false" placeholder="اكتب هنا...">${data.html}</div>
                <div class="resize-handle"></div>
            `;

            makeDraggable(note, note.querySelector('.move-btn'));
            makeResizable(note);
            
            const contentDiv = note.querySelector('.note-content');
            contentDiv.addEventListener('input', saveCurrentBoard);
            contentDiv.addEventListener('touchstart', (e) => e.stopPropagation());
            
            note.addEventListener('mousedown', () => note.style.zIndex = zIndexCounter++);
            note.addEventListener('touchstart', () => note.style.zIndex = zIndexCounter++, {passive: true});

            board.appendChild(note);
        }

        // --- وظيفة الحذف الجديدة باستخدام Modal ---
        function deleteNote(id) {
            showConfirm('هل تريد حذف هذه الورقة نهائياً؟', () => {
                const note = document.getElementById(id);
                if (note) {
                    note.remove();
                    saveCurrentBoard();
                }
            });
        }

        function clearCurrentBoard() {
            showConfirm('هل أنت متأكد من مسح جميع محتويات هذه السبورة؟', () => {
                board.innerHTML = '';
                saveCurrentBoard();
            });
        }

        function makeDraggable(el, handle) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            function start(e) {
                // التأكد من أن الحدث ليس من زر الحذف
                if (e.target.closest('.delete-btn')) return;

                isDragging = true;
                el.classList.add('dragging');
                el.style.zIndex = zIndexCounter++;
                
                const evt = e.type.includes('touch') ? e.touches[0] : e;
                startX = evt.clientX;
                startY = evt.clientY;
                initialLeft = el.offsetLeft;
                initialTop = el.offsetTop;
                
                if(e.cancelable) e.preventDefault();
            }

            function move(e) {
                if (!isDragging) return;
                const evt = e.type.includes('touch') ? e.touches[0] : e;
                if(e.type === 'touchmove') e.preventDefault();

                const dx = evt.clientX - startX;
                const dy = evt.clientY - startY;
                
                let newLeft = initialLeft + dx;
                let newTop = initialTop + dy;

                const boardRect = board.getBoundingClientRect();
                const noteRect = el.getBoundingClientRect();
                
                if (newLeft < -noteRect.width + 50) newLeft = -noteRect.width + 50;
                if (newLeft > boardRect.width - 50) newLeft = boardRect.width - 50;
                if (newTop < 55) newTop = 55;
                if (newTop > boardRect.height - 50) newTop = boardRect.height - 50;

                el.style.left = `${newLeft}px`;
                el.style.top = `${newTop}px`;
            }

            function end() {
                if(isDragging) {
                    isDragging = false;
                    el.classList.remove('dragging');
                    saveCurrentBoard();
                }
            }

            const header = el.querySelector('.note-header');
            
            header.addEventListener('mousedown', start);
            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);

            header.addEventListener('touchstart', start, {passive: false});
            window.addEventListener('touchmove', move, {passive: false});
            window.addEventListener('touchend', end);
        }

        function makeResizable(el) {
            const handle = el.querySelector('.resize-handle');
            let isResizing = false, startX, startY, startW, startH;

            function start(e) {
                isResizing = true;
                e.stopPropagation();
                if(e.cancelable) e.preventDefault();
                const evt = e.type.includes('touch') ? e.touches[0] : e;
                startX = evt.clientX;
                startY = evt.clientY;
                startW = parseInt(getComputedStyle(el).width);
                startH = parseInt(getComputedStyle(el).height);
            }

            function move(e) {
                if (!isResizing) return;
                if(e.type === 'touchmove') e.preventDefault();
                const evt = e.type.includes('touch') ? e.touches[0] : e;
                
                const dx = evt.clientX - startX;
                const dy = evt.clientY - startY;

                const newW = startW - dx; 
                const newH = startH + dy;

                if(newW > 150) el.style.width = `${newW}px`;
                if(newH > 150) el.style.height = `${newH}px`;
            }

            function end() {
                if(isResizing) {
                    isResizing = false;
                    saveCurrentBoard();
                }
            }

            handle.addEventListener('mousedown', start);
            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
            handle.addEventListener('touchstart', start, {passive: false});
            window.addEventListener('touchmove', move, {passive: false});
            window.addEventListener('touchend', end);
        }

        function initColorPicker() {
            const container = document.getElementById('colorPicker');
            colors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = `w-8 h-8 rounded-full cursor-pointer border-2 border-transparent hover:scale-110 transition-transform shadow-sm`;
                dot.style.backgroundColor = c;
                if(c === currentSettings.color) dot.classList.add('border-gray-500');
                
                dot.onclick = () => {
                    currentSettings.color = c;
                    container.querySelectorAll('div').forEach(d => d.classList.remove('border-gray-500'));
                    dot.classList.add('border-gray-500');
                    if(currentSettings.style === 'kraft') {
                         setNoteStyle('plain', document.querySelector("button[onclick*='plain']"));
                    }
                };
                container.appendChild(dot);
            });
        }

        function setNoteStyle(style, btn) {
            currentSettings.style = style;
            document.querySelectorAll('.style-option').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setCurrentFont(font) {
            currentSettings.font = font;
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addNote('', null, null, e.target.result);
                    input.value = '';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('active');
        }

        function toggleTheme(forceDark = false) {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            const isDark = forceDark || !html.hasAttribute('data-theme');
            
            if (isDark) {
                html.setAttribute('data-theme', 'dark');
                icon.className = 'fa-solid fa-sun';
                localStorage.setItem('boardTheme', 'dark');
            } else {
                html.removeAttribute('data-theme');
                icon.className = 'fa-solid fa-moon';
                localStorage.setItem('boardTheme', 'light');
            }
        }

        document.addEventListener('click', (e) => {
            const settings = document.getElementById('settingsPanel');
            const toggleBtn = document.querySelector('.fa-paintbrush');
            if(settings.classList.contains('active') && !settings.contains(e.target) && !toggleBtn.parentNode.contains(e.target)) {
                settings.classList.remove('active');
            }
        });

    </script>
</body>
</html>
